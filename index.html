<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    
    <!-- Cache control for HTML - allow short cache for updates -->
    <meta http-equiv="Cache-Control" content="public, max-age=3600, must-revalidate" />
    
    <!-- Performance optimizations -->
    <meta name="theme-color" content="#FF6B35" />
    <meta name="description" content="ReRide - Buy and sell quality used vehicles with confidence. AI-powered recommendations and certified inspections." />
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ReRide" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png" />
    
    <!-- Preconnect to external domains for faster loading (preconnect is preferred over dns-prefetch) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- DNS prefetch for other external domains -->
    <link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">
    <link rel="dns-prefetch" href="https://i.pravatar.cc">
    
    <!-- Load fonts with display=swap and media=print trick for async loading -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Nunito+Sans:wght@600;700;800&display=swap" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Nunito+Sans:wght@600;700;800&display=swap"></noscript>
    
    <!-- Preload critical font files for faster rendering - using font-display: swap -->
    <!-- Note: Actual font URLs will be determined by Google Fonts, but preconnect helps -->
    
    <!-- CRITICAL: Polyfill process.emitWarning BEFORE any modules load -->
    <script>
      // Polyfill process.emitWarning for browser compatibility - must run FIRST
      (function() {
        if (typeof window !== 'undefined') {
          if (typeof process === 'undefined') {
            window.process = { env: {} };
          }
          if (!window.process.emitWarning) {
            window.process.emitWarning = function(msg, type, code, ctor) {
              // Silently handle warnings to prevent errors
              if (typeof console !== 'undefined' && console.warn) {
                console.warn('[process.emitWarning]', msg);
              }
            };
          }
          // Ensure process is available globally
          if (typeof globalThis !== 'undefined') {
            globalThis.process = window.process;
          }
        }
      })();
    </script>
    
    <!-- Prefetch API endpoints only in production or when API server is confirmed available -->
    <script>
      
      // Only prefetch if we're in production mode (not localhost)
      (function() {
        const isLocalhost = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname.includes('localhost');
        
        // Skip prefetch in development to avoid 404 errors when API server isn't running
        if (isLocalhost) {
          return;
        }
        
        // In production, prefetch after page load
        window.addEventListener('load', () => {
          setTimeout(() => {
            // Check if API server is available before prefetching
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 2000);
            
            fetch('/api/vehicles?limit=30&skipExpiryCheck=true', { 
              method: 'HEAD', 
              cache: 'default',
              signal: controller.signal
            })
              .then(response => {
                clearTimeout(timeoutId);
                if (response.ok) {
                  // OLX-STYLE: Prefetch first page for instant display
                  const link1 = document.createElement('link');
                  link1.rel = 'prefetch';
                  link1.href = '/api/vehicles?limit=30&skipExpiryCheck=true';
                  document.head.appendChild(link1);
                  
                  // Prefetch next page (OLX loads next page in background)
                  const link2 = document.createElement('link');
                  link2.rel = 'prefetch';
                  link2.href = '/api/vehicles?limit=30&page=2&skipExpiryCheck=true';
                  document.head.appendChild(link2);
                  
                  // Prefetch users data
                  const link3 = document.createElement('link');
                  link3.rel = 'prefetch';
                  link3.href = '/api/users';
                  document.head.appendChild(link3);
                }
              })
              .catch(() => {
                clearTimeout(timeoutId);
                // Silently fail if API server is not available
              });
          }, 2000);
        });
      })();
    </script>
    
    <title>ReRide - Buy & Sell Quality Used Vehicles</title>
    
    <!-- Critical CSS - Inlined for above-the-fold content to prevent render-blocking -->
    <style id="critical-css">
      /* Vehicle Card Critical Styles */
      .vehicle-card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; padding: 1rem; }
      .vehicle-card { background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
      .vehicle-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
      .vehicle-image { width: 100%; height: 200px; object-fit: cover; background: linear-gradient(to bottom, #f3f4f6, #e5e7eb); }
      .vehicle-info { padding: 1rem; }
      .vehicle-title { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem; }
      .vehicle-price { font-size: 1.5rem; font-weight: 800; color: #ff6b35; margin-top: 0.75rem; }
      .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
      @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
      .filter-bar { background: white; padding: 1rem; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
      .search-bar { background: white; border-radius: 0.75rem; padding: 0.75rem 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
      .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
      @media (max-width: 640px) { .vehicle-card-container { grid-template-columns: 1fr; gap: 1rem; padding: 0.5rem; } .vehicle-image { height: 180px; } }
    </style>
    
    <!-- Fix for zoom issues - ensure proper viewport scaling -->
    <script>
      // Ensure viewport is set correctly and reset any zoom
      (function() {
        // Force viewport meta tag
        let viewport = document.querySelector('meta[name="viewport"]');
        if (!viewport) {
          viewport = document.createElement('meta');
          viewport.name = 'viewport';
          document.getElementsByTagName('head')[0].appendChild(viewport);
        }
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, shrink-to-fit=no';
        
        // ✅ FIX: Reset any CSS zoom - check if elements exist first
        if (document.documentElement) {
          document.documentElement.style.zoom = '1';
        }
        // ✅ FIX: Check if body exists before accessing its style
        if (document.body) {
          document.body.style.zoom = '1';
        } else {
          // If body doesn't exist yet, wait for DOMContentLoaded
          document.addEventListener('DOMContentLoaded', function() {
            if (document.body) {
              document.body.style.zoom = '1';
            }
          });
        }
        
        // Prevent text size adjustment that causes zooming
        if (document.documentElement && 'textSizeAdjust' in document.documentElement.style) {
          document.documentElement.style.textSizeAdjust = '100%';
        }
      })();
    </script>
  </head>
  <body class="antialiased transition-colors duration-300" style="background-color: #FFFFFF; color: #2C2C2C;">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link" style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;">Skip to main content</a>
    <style>
      .skip-link:focus {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10000;
        width: auto;
        height: auto;
        padding: 1rem 2rem;
        background: #FF6B35;
        color: white;
        text-decoration: none;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
    </style>
    <!-- Loading indicator -->
    <div id="root">
      <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#FFFFFF;">
        <div style="text-align:center;">
          <div style="width:50px;height:50px;border:4px solid #F5F5F5;border-top-color:#FF6B35;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
          <p style="color:#2C2C2C;font-size:16px;font-weight:600;">Loading ReRide...</p>
        </div>
      </div>
    </div>
    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    <script type="module" src="/index.tsx"></script>
    <!-- Safety timeout: If React doesn't mount within 15 seconds, show error message -->
    <script>
      (function() {
        let timeoutId;
        let checkInterval;
        let reactMounted = false;
        
        // Better detection: Check if React has mounted by looking for React root attributes
        const checkReactMounted = function() {
          const root = document.getElementById('root');
          if (!root) return false;
          
          // React 18+ creates a root with data-reactroot or specific structure
          // Check if root has been modified by React (not just the initial HTML)
          const hasReactContent = root.children.length > 0 && (
            root.querySelector('[data-reactroot]') !== null ||
            root.getAttribute('data-reactroot') !== null ||
            root.innerHTML !== '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#FFFFFF;"><div style="text-align:center;"><div style="width:50px;height:50px;border:4px solid #F5F5F5;border-top-color:#FF6B35;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div><p style="color:#2C2C2C;font-size:16px;font-weight:600;">Loading ReRide...</p></div></div>'
          );
          
          return hasReactContent;
        };
        
        // Set timeout to show error if React doesn't mount
        timeoutId = setTimeout(function() {
          if (!reactMounted) {
            const root = document.getElementById('root');
            if (root && !checkReactMounted()) {
              // React hasn't mounted yet, show error message
              root.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#FFFFFF;padding:20px;"><div style="text-align:center;max-width:600px;"><h1 style="color:#2C2C2C;font-size:24px;font-weight:700;margin-bottom:16px;">Unable to Load ReRide</h1><p style="color:#666;font-size:16px;margin-bottom:24px;line-height:1.6;">The application is taking longer than expected to load. Please try refreshing the page.</p><button onclick="window.location.reload()" style="background:#FF6B35;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background=\'#E55A2B\'" onmouseout="this.style.background=\'#FF6B35\'">Refresh Page</button></div></div>';
            }
          }
        }, 15000); // Increased to 15 seconds to allow for slower networks
        
        // Check if React has mounted
        const startChecking = function() {
          checkInterval = setInterval(function() {
            if (checkReactMounted()) {
              reactMounted = true;
              clearTimeout(timeoutId);
              clearInterval(checkInterval);
            }
          }, 500); // Check every 500ms for faster detection
          
          // Clear check interval after 20 seconds
          setTimeout(function() {
            if (checkInterval) {
              clearInterval(checkInterval);
            }
          }, 20000);
        };
        
        // Start checking immediately and on DOMContentLoaded
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', startChecking);
        } else {
          startChecking();
        }
      })();
    </script>
  </body>
</html>