<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate Vehicles to Production</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .section h2 {
            margin-top: 0;
            color: #444;
        }
        input, textarea, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        .info {
            background: #2196F3;
        }
        .info:hover {
            background: #0b7dda;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Vehicle Migration Tool</h1>
        <p class="subtitle">Migrate vehicles from localStorage to production database</p>

        <div class="section">
            <h2>Step 1: Configuration</h2>
            <label>Your Seller Email:</label>
            <input type="email" id="sellerEmail" placeholder="seller@test.com" value="seller@test.com">
            
            <label>API Base URL (leave empty for current domain):</label>
            <input type="text" id="apiBaseUrl" placeholder="https://your-app.vercel.app or leave empty">
            
            <button class="info" onclick="loadLocalVehicles()">üì• Load Vehicles from localStorage</button>
        </div>

        <div class="section" id="statsSection" style="display: none;">
            <h2>Statistics</h2>
            <div class="stats" id="statsContainer"></div>
        </div>

        <div class="section">
            <h2>Step 2: Review & Migrate</h2>
            <div id="statusContainer"></div>
            <button id="migrateBtn" onclick="migrateVehicles()" disabled>üöÄ Migrate Vehicles to Production</button>
            <button class="danger" onclick="clearExpiredListings()" style="margin-top: 10px;">üîÑ Fix Expired Listings (Premium Plan)</button>
        </div>

        <div class="section">
            <h2>Step 3: Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script>
        let localVehicles = [];
        let sellerEmail = '';
        let apiBaseUrl = '';

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            logContainer.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        async function loadLocalVehicles() {
            try {
                sellerEmail = document.getElementById('sellerEmail').value.trim().toLowerCase();
                apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
                
                if (!sellerEmail) {
                    showStatus('Please enter your seller email', 'error');
                    log('‚ùå Seller email is required', 'error');
                    return;
                }

                log('üì• Loading vehicles from localStorage...');
                
                // Get vehicles from localStorage
                const vehiclesJson = localStorage.getItem('reRideVehicles');
                if (!vehiclesJson) {
                    showStatus('No vehicles found in localStorage', 'error');
                    log('‚ùå No vehicles found in localStorage', 'error');
                    return;
                }

                const allVehicles = JSON.parse(vehiclesJson);
                log(`‚úÖ Found ${allVehicles.length} total vehicles in localStorage`);

                // Filter vehicles for this seller
                localVehicles = allVehicles.filter(v => {
                    const vehicleEmail = (v.sellerEmail || '').toLowerCase().trim();
                    return vehicleEmail === sellerEmail;
                });

                log(`‚úÖ Found ${localVehicles.length} vehicles for ${sellerEmail}`);

                if (localVehicles.length === 0) {
                    showStatus('No vehicles found for this seller email in localStorage', 'error');
                    return;
                }

                // Show statistics
                displayStats(localVehicles);
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('migrateBtn').disabled = false;

                showStatus(`Found ${localVehicles.length} vehicles ready to migrate`, 'success');
                log(`‚úÖ Ready to migrate ${localVehicles.length} vehicles`, 'success');

            } catch (error) {
                showStatus('Error loading vehicles: ' + error.message, 'error');
                log('‚ùå Error: ' + error.message, 'error');
            }
        }

        function displayStats(vehicles) {
            const stats = {
                total: vehicles.length,
                published: vehicles.filter(v => v.status === 'published').length,
                unpublished: vehicles.filter(v => v.status === 'unpublished').length,
                sold: vehicles.filter(v => v.status === 'sold').length,
                withExpiry: vehicles.filter(v => v.listingExpiresAt).length,
                expired: vehicles.filter(v => {
                    if (!v.listingExpiresAt) return false;
                    return new Date(v.listingExpiresAt) < new Date();
                }).length
            };

            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-card">
                    <h3>Total Vehicles</h3>
                    <div class="value">${stats.total}</div>
                </div>
                <div class="stat-card">
                    <h3>Published</h3>
                    <div class="value">${stats.published}</div>
                </div>
                <div class="stat-card">
                    <h3>Unpublished</h3>
                    <div class="value">${stats.unpublished}</div>
                </div>
                <div class="stat-card">
                    <h3>Sold</h3>
                    <div class="value">${stats.sold}</div>
                </div>
                <div class="stat-card">
                    <h3>With Expiry Date</h3>
                    <div class="value">${stats.withExpiry}</div>
                </div>
                <div class="stat-card">
                    <h3>Expired</h3>
                    <div class="value">${stats.expired}</div>
                </div>
            `;
        }

        async function migrateVehicles() {
            if (localVehicles.length === 0) {
                showStatus('No vehicles to migrate. Please load vehicles first.', 'error');
                return;
            }

            const baseUrl = apiBaseUrl || window.location.origin;
            const migrateBtn = document.getElementById('migrateBtn');
            migrateBtn.disabled = true;
            migrateBtn.textContent = 'Migrating...';

            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;

            log(`üöÄ Starting migration of ${localVehicles.length} vehicles to ${baseUrl}...`);

            for (let i = 0; i < localVehicles.length; i++) {
                const vehicle = localVehicles[i];
                
                try {
                    // Normalize sellerEmail
                    const normalizedVehicle = {
                        ...vehicle,
                        sellerEmail: sellerEmail.toLowerCase().trim(),
                        // Remove listingExpiresAt for Premium plans (unlimited listings)
                        listingExpiresAt: undefined,
                        // Ensure status is published
                        status: vehicle.status || 'published',
                        // Ensure createdAt exists
                        createdAt: vehicle.createdAt || new Date().toISOString()
                    };

                    log(`üì§ Migrating vehicle ${i + 1}/${localVehicles.length}: ${vehicle.make} ${vehicle.model} (ID: ${vehicle.id})...`);

                    const response = await fetch(`${baseUrl}/api/vehicles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(normalizedVehicle)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        successCount++;
                        log(`‚úÖ Vehicle ${i + 1} migrated successfully`, 'success');
                    } else {
                        // Check if vehicle already exists (duplicate ID)
                        if (result.reason && result.reason.includes('duplicate') || result.reason && result.reason.includes('already exists')) {
                            skippedCount++;
                            log(`‚è≠Ô∏è  Vehicle ${i + 1} already exists, skipping...`, 'info');
                        } else {
                            errorCount++;
                            log(`‚ùå Vehicle ${i + 1} failed: ${result.reason || result.error || 'Unknown error'}`, 'error');
                        }
                    }

                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 100));

                } catch (error) {
                    errorCount++;
                    log(`‚ùå Error migrating vehicle ${i + 1}: ${error.message}`, 'error');
                }
            }

            const summary = `
                Migration Complete!
                ‚úÖ Success: ${successCount}
                ‚è≠Ô∏è  Skipped: ${skippedCount}
                ‚ùå Errors: ${errorCount}
            `;

            showStatus(summary, successCount > 0 ? 'success' : 'error');
            log(summary, successCount > 0 ? 'success' : 'error');

            migrateBtn.disabled = false;
            migrateBtn.textContent = 'üöÄ Migrate Vehicles to Production';
        }

        async function clearExpiredListings() {
            if (!sellerEmail) {
                showStatus('Please enter your seller email first', 'error');
                return;
            }

            const baseUrl = apiBaseUrl || window.location.origin;
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Fixing...';

            log('üîÑ Fixing expired listings for Premium plan...');

            try {
                // First, get all vehicles from API
                const response = await fetch(`${baseUrl}/api/vehicles`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch vehicles: ${response.statusText}`);
                }

                const allVehicles = await response.json();
                const sellerVehicles = allVehicles.filter(v => 
                    (v.sellerEmail || '').toLowerCase().trim() === sellerEmail
                );

                log(`‚úÖ Found ${sellerVehicles.length} vehicles for ${sellerEmail}`);

                let fixedCount = 0;
                const now = new Date();

                for (const vehicle of sellerVehicles) {
                    // Check if vehicle is expired and should be fixed
                    if (vehicle.listingExpiresAt) {
                        const expiryDate = new Date(vehicle.listingExpiresAt);
                        if (expiryDate < now && vehicle.status === 'unpublished') {
                            // Update vehicle to remove expiry and republish
                            try {
                                const updateResponse = await fetch(`${baseUrl}/api/vehicles`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json'
                                    },
                                    credentials: 'include',
                                    body: JSON.stringify({
                                        id: vehicle.id,
                                        listingExpiresAt: undefined,
                                        status: 'published',
                                        listingStatus: 'active'
                                    })
                                });

                                if (updateResponse.ok) {
                                    fixedCount++;
                                    log(`‚úÖ Fixed vehicle ${vehicle.id}: ${vehicle.make} ${vehicle.model}`, 'success');
                                } else {
                                    const error = await updateResponse.json();
                                    log(`‚ùå Failed to fix vehicle ${vehicle.id}: ${error.reason || 'Unknown error'}`, 'error');
                                }
                            } catch (error) {
                                log(`‚ùå Error fixing vehicle ${vehicle.id}: ${error.message}`, 'error');
                            }
                        }
                    }
                }

                showStatus(`Fixed ${fixedCount} expired listings`, fixedCount > 0 ? 'success' : 'info');
                log(`‚úÖ Fixed ${fixedCount} expired listings`, 'success');

            } catch (error) {
                showStatus('Error fixing expired listings: ' + error.message, 'error');
                log('‚ùå Error: ' + error.message, 'error');
            }

            button.disabled = false;
            button.textContent = 'üîÑ Fix Expired Listings (Premium Plan)';
        }
    </script>
</body>
</html>

