<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .test-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .test-item h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border-left: 3px solid #28a745;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 3px solid #dc3545;
        }
        .config-check {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #d0e7ff;
        }
        .config-item:last-child {
            border-bottom: none;
        }
        .config-label {
            font-weight: 600;
            color: #004085;
        }
        .config-value {
            color: #0066cc;
            font-family: monospace;
            font-size: 12px;
        }
        .config-value.missing {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firebase Authentication Test</h1>
        <p class="subtitle">Test Google Sign-In and Mobile OTP authentication</p>

        <div class="config-check">
            <h2>üìã Configuration Check</h2>
            <div id="config-status"></div>
        </div>

        <div class="section">
            <h2>üîê Google Sign-In Test</h2>
            <div class="test-item">
                <h3>Test Google Authentication <span class="status pending" id="google-status">Pending</span></h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    Click the button below to test Google Sign-In. A popup will appear for authentication.
                </p>
                <button id="test-google" onclick="testGoogleSignIn()">Test Google Sign-In</button>
                <div id="google-result"></div>
            </div>
        </div>

        <div class="section">
            <h2>üì± Mobile OTP Test</h2>
            <div class="test-item">
                <h3>Test Phone Number OTP <span class="status pending" id="otp-status">Pending</span></h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    Enter a phone number to test OTP authentication. Format: +91XXXXXXXXXX or 10-digit number.
                </p>
                <input 
                    type="tel" 
                    id="phone-input" 
                    placeholder="Enter phone number (e.g., +919876543210)"
                    style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; font-size: 14px;"
                />
                <button id="test-otp-send" onclick="testSendOTP()">Send OTP</button>
                <div id="otp-send-result"></div>
                
                <div id="otp-verify-section" style="display: none; margin-top: 15px;">
                    <input 
                        type="text" 
                        id="otp-input" 
                        placeholder="Enter 6-digit OTP"
                        maxlength="6"
                        style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; font-size: 14px; text-align: center; letter-spacing: 8px; font-size: 20px;"
                    />
                    <button id="test-otp-verify" onclick="testVerifyOTP()">Verify OTP</button>
                    <div id="otp-verify-result"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîó Backend Sync Test</h2>
            <div class="test-item">
                <h3>Test Backend Integration <span class="status pending" id="backend-status">Pending</span></h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    Test if Firebase authentication syncs with your backend API.
                </p>
                <button id="test-backend" onclick="testBackendSync()">Test Backend Sync</button>
                <div id="backend-result"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Check Firebase configuration
        function checkConfig() {
            const configStatus = document.getElementById('config-status');
            const requiredVars = [
                'VITE_FIREBASE_API_KEY',
                'VITE_FIREBASE_AUTH_DOMAIN',
                'VITE_FIREBASE_PROJECT_ID',
                'VITE_FIREBASE_STORAGE_BUCKET',
                'VITE_FIREBASE_MESSAGING_SENDER_ID',
                'VITE_FIREBASE_APP_ID'
            ];

            let html = '';
            let allConfigured = true;

            requiredVars.forEach(varName => {
                // In browser, we can't directly access env vars, so we'll check if Firebase initializes
                const isConfigured = true; // Will be checked when Firebase initializes
                html += `
                    <div class="config-item">
                        <span class="config-label">${varName}</span>
                        <span class="config-value ${isConfigured ? '' : 'missing'}">
                            ${isConfigured ? '‚úÖ Configured' : '‚ùå Missing'}
                        </span>
                    </div>
                `;
            });

            configStatus.innerHTML = html;
        }

        // Test Google Sign-In
        window.testGoogleSignIn = async function() {
            const statusEl = document.getElementById('google-status');
            const resultEl = document.getElementById('google-result');
            const button = document.getElementById('test-google');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status pending';
            button.disabled = true;
            resultEl.innerHTML = '';

            try {
                // Import Firebase auth service
                const { signInWithGoogle } = await import('/services/authService.ts');
                
                resultEl.innerHTML = '<div class="result">üîÑ Initiating Google Sign-In...</div>';
                
                const result = await signInWithGoogle();

                if (result.success) {
                    statusEl.textContent = 'Success';
                    statusEl.className = 'status success';
                    resultEl.innerHTML = `
                        <div class="result success">
                            ‚úÖ Google Sign-In Successful!
                            <br><br>
                            <strong>User Data:</strong>
                            <br>Email: ${result.user?.email || 'N/A'}
                            <br>Name: ${result.user?.name || 'N/A'}
                            <br>UID: ${result.user?.uid || 'N/A'}
                            <br>Email Verified: ${result.user?.emailVerified ? 'Yes' : 'No'}
                        </div>
                    `;
                } else {
                    statusEl.textContent = 'Failed';
                    statusEl.className = 'status error';
                    resultEl.innerHTML = `
                        <div class="result error">
                            ‚ùå Google Sign-In Failed
                            <br><br>
                            <strong>Error:</strong> ${result.reason || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status error';
                resultEl.innerHTML = `
                    <div class="result error">
                        ‚ùå Error: ${error.message}
                        <br><br>
                        <strong>Possible causes:</strong>
                        <br>1. Firebase not configured
                        <br>2. Google Sign-In not enabled in Firebase Console
                        <br>3. Popup blocked by browser
                    </div>
                `;
            } finally {
                button.disabled = false;
            }
        };

        // Test Send OTP
        let confirmationResult = null;
        window.testSendOTP = async function() {
            const phoneInput = document.getElementById('phone-input');
            const phoneNumber = phoneInput.value.trim();
            const statusEl = document.getElementById('otp-status');
            const resultEl = document.getElementById('otp-send-result');
            const button = document.getElementById('test-otp-send');
            const verifySection = document.getElementById('otp-verify-section');

            if (!phoneNumber) {
                resultEl.innerHTML = '<div class="result error">‚ùå Please enter a phone number</div>';
                return;
            }

            statusEl.textContent = 'Sending...';
            statusEl.className = 'status pending';
            button.disabled = true;
            resultEl.innerHTML = '';

            try {
                const { sendOTP, initializeRecaptcha } = await import('/services/authService.ts');
                
                // Initialize reCAPTCHA
                initializeRecaptcha('recaptcha-container');
                
                resultEl.innerHTML = '<div class="result">üîÑ Sending OTP...</div>';
                
                const result = await sendOTP(phoneNumber);

                if (result.success && result.confirmationResult) {
                    confirmationResult = result.confirmationResult;
                    statusEl.textContent = 'OTP Sent';
                    statusEl.className = 'status success';
                    resultEl.innerHTML = `
                        <div class="result success">
                            ‚úÖ OTP sent successfully to ${phoneNumber}
                            <br><br>
                            Please check your phone for the verification code.
                        </div>
                    `;
                    verifySection.style.display = 'block';
                } else {
                    statusEl.textContent = 'Failed';
                    statusEl.className = 'status error';
                    resultEl.innerHTML = `
                        <div class="result error">
                            ‚ùå Failed to send OTP
                            <br><br>
                            <strong>Error:</strong> ${result.reason || 'Unknown error'}
                            <br><br>
                            <strong>Possible causes:</strong>
                            <br>1. Phone authentication not enabled in Firebase Console
                            <br>2. Invalid phone number format
                            <br>3. reCAPTCHA not initialized
                        </div>
                    `;
                }
            } catch (error) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status error';
                resultEl.innerHTML = `
                    <div class="result error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            } finally {
                button.disabled = false;
            }
        };

        // Test Verify OTP
        window.testVerifyOTP = async function() {
            const otpInput = document.getElementById('otp-input');
            const otp = otpInput.value.trim();
            const resultEl = document.getElementById('otp-verify-result');
            const button = document.getElementById('test-otp-verify');
            const statusEl = document.getElementById('otp-status');

            if (!otp || otp.length !== 6) {
                resultEl.innerHTML = '<div class="result error">‚ùå Please enter a valid 6-digit OTP</div>';
                return;
            }

            if (!confirmationResult) {
                resultEl.innerHTML = '<div class="result error">‚ùå Please send OTP first</div>';
                return;
            }

            button.disabled = true;
            resultEl.innerHTML = '';

            try {
                const { verifyOTP } = await import('/services/authService.ts');
                
                resultEl.innerHTML = '<div class="result">üîÑ Verifying OTP...</div>';
                
                const result = await verifyOTP(confirmationResult, otp);

                if (result.success) {
                    statusEl.textContent = 'Verified';
                    statusEl.className = 'status success';
                    resultEl.innerHTML = `
                        <div class="result success">
                            ‚úÖ OTP verified successfully!
                            <br><br>
                            <strong>User Data:</strong>
                            <br>Phone: ${result.user?.phoneNumber || 'N/A'}
                            <br>UID: ${result.user?.uid || 'N/A'}
                        </div>
                    `;
                } else {
                    statusEl.textContent = 'Invalid';
                    statusEl.className = 'status error';
                    resultEl.innerHTML = `
                        <div class="result error">
                            ‚ùå Invalid OTP
                            <br><br>
                            <strong>Error:</strong> ${result.reason || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status error';
                resultEl.innerHTML = `
                    <div class="result error">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            } finally {
                button.disabled = false;
            }
        };

        // Test Backend Sync
        window.testBackendSync = async function() {
            const statusEl = document.getElementById('backend-status');
            const resultEl = document.getElementById('backend-result');
            const button = document.getElementById('test-backend');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status pending';
            button.disabled = true;
            resultEl.innerHTML = '';

            try {
                resultEl.innerHTML = '<div class="result">üîÑ Testing backend API...</div>';
                
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'oauth-login',
                        firebaseUid: 'test-uid-123',
                        email: 'test@example.com',
                        name: 'Test User',
                        mobile: '',
                        avatarUrl: '',
                        role: 'customer',
                        authProvider: 'google'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.textContent = 'Success';
                    statusEl.className = 'status success';
                    resultEl.innerHTML = `
                        <div class="result success">
                            ‚úÖ Backend sync working!
                            <br><br>
                            <strong>Response:</strong>
                            <br>${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                } else {
                    statusEl.textContent = 'Failed';
                    statusEl.className = 'status error';
                    resultEl.innerHTML = `
                        <div class="result error">
                            ‚ùå Backend sync failed
                            <br><br>
                            <strong>Status:</strong> ${response.status}
                            <br><strong>Response:</strong> ${JSON.stringify(data, null, 2)}
                        </div>
                    `;
                }
            } catch (error) {
                statusEl.textContent = 'Error';
                statusEl.className = 'status error';
                resultEl.innerHTML = `
                    <div class="result error">
                        ‚ùå Error: ${error.message}
                        <br><br>
                        <strong>Possible causes:</strong>
                        <br>1. Backend API not running
                        <br>2. Network error
                        <br>3. CORS issue
                    </div>
                `;
            } finally {
                button.disabled = false;
            }
        };

        // Initialize
        checkConfig();
        
        // Add reCAPTCHA container
        const recaptchaContainer = document.createElement('div');
        recaptchaContainer.id = 'recaptcha-container';
        recaptchaContainer.style.display = 'none';
        document.body.appendChild(recaptchaContainer);
    </script>
</body>
</html>


